# 数据库迁移脚本

## Content Hash 迁移

为图片添加 MD5 哈希值，用于内容去重和快速查找。

### 使用方法

#### 方法 1: 一键迁移（推荐）

```bash
cd /Users/mac/code/python/comfyui-helper/backend
uv run scripts/migrate_content_hash.py
```

这会自动执行：
1. 添加 `content_hash` 字段到数据库
2. 为所有已存在的图片计算并更新 MD5

#### 方法 2: 分步执行

如果需要分步执行，可以单独运行：

```bash
# 步骤 1: 添加字段
uv run scripts/add_content_hash_column.py

# 步骤 2: 更新 MD5
uv run scripts/update_content_hash.py
```

### 说明

- **安全性**: 脚本会先检查字段是否已存在，避免重复添加
- **进度显示**: 每 100 张图片显示一次进度
- **错误处理**: 单张图片失败不会影响其他图片的处理
- **性能**: 直接从块存储读取，速度较快

### 预期输出

```
============================================================
Content Hash 迁移工具
============================================================

步骤 1/2: 添加数据库字段
------------------------------------------------------------
添加 content_hash 字段...
创建索引...
✓ 字段添加成功！

步骤 2/2: 更新已存在图片的 MD5
------------------------------------------------------------
开始更新图片 MD5 哈希值...
找到 270 张需要更新的图片
[100/270] 已更新 100 张，失败 0 张
[200/270] 已更新 200 张，失败 0 张
[270/270] 已更新 270 张，失败 0 张

更新完成！
  成功: 270 张
  失败: 0 张
  总计: 270 张

============================================================
迁移完成！
============================================================
```

### 注意事项

1. **备份数据库**: 建议先备份数据库（自动备份在 `data/backups/`）
2. **停止服务**: 建议在服务停止时执行迁移，避免并发问题
3. **磁盘空间**: 确保有足够的磁盘空间（至少与图片总大小相当）
4. **执行时间**: 根据图片数量，可能需要几分钟到几十分钟

### 验证

迁移完成后，可以查询验证：

```python
# 检查有多少图片已有 MD5
SELECT COUNT(*) FROM stored_images WHERE content_hash IS NOT NULL;

# 检查是否有重复内容的图片
SELECT content_hash, COUNT(*) as count 
FROM stored_images 
WHERE content_hash IS NOT NULL 
GROUP BY content_hash 
HAVING count > 1;
```
